{{define "body"}}
<h1>Admin</h1>
<h3>System</h3>
<div>Home Disk Usage: {{.DiskUsage}}</div>
<div>Uptime: {{.Uptime}}</div>
<br />
<details>
    <summary>System Control</summary>
    <br />
    <button onclick="systemCall('reboot')">
        Reboot
    </button>
    <br />
    <br />
    <button onclick="systemCall('poweroff')">
        Poweroff
    </button>
</details>
<br />
<h3>Users</h3>
<button onclick="document.getElementById('create-user-dialog').showModal()">
    Create New User
</button>
<br />
<br />
<table>
    <thead>
        <tr>
            <th>Username</th>
            <th>Disk Usage</th>
            <th>Is Admin</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {{range .UserListItems}}
        <tr>
            <td>{{.Username}}</td>
            <td>{{.DiskUsage}}</td>
            <td>
                {{if .IsAdmin}}
                Yes
                {{else}}
                No
                {{end}}
            </td>
            <td>
                <button onclick="window.location.href='/user/{{.Username}}'">
                    Manage User
                </button>
            </td>
            <td>
                {{if ne $.Username .Username}}
                <button onclick="impersonateUser('{{.Username}}')">
                    Impersonate User
                </button>
                {{else}}
                (current user)
                {{end}}
            </td>
        </tr>
        {{end}}
    </tbody>
</table>
<br />
<dialog id="create-user-dialog">
    <div style="display: grid; grid-auto-flow: column">
        <div>
            <h3>Create New User</h3>
        </div>
        <div>
            <span
                class="close-button"
                onclick="document.getElementById('create-user-dialog').close()"
            >&#128938;</span>
        </div>
    </div>
    <form id="create-user-form">
        <label for="createUsername">Username:</label>
        <input
            type="text"
            id="createUsername"
            name="username"
            maxlength="32"
            placeholder="Enter Username"
            required="required"
            autocomplete="off"
        />
        <br />
        <br />
        <input
            type="submit"
            value="Create User"
        />
    </form>
</dialog>
<script>
    function systemCall(callMethod) {
        customConfirm(`Are you sure you want to ${callMethod} the system?`).then(confirmed => {
            if (confirmed) {
                toggleLoading();
                const reloadTimeout = setTimeout(() => location.reload(), 5000);
                fetch(`/api/system/${callMethod}`, { method: "POST" }).then((response) => {
                    if (response.ok) {
                        // success, wait for timeout reload
                    } else {
                        clearTimeout(reloadTimeout);
                        response.text().then((text) => notifyError(text));
                        toggleLoading();
                    }
                });
            }
        });
    }

    document.getElementById("create-user-form").addEventListener("submit", function (event) {
        event.preventDefault();
        const formData = new FormData(this);
        const username = formData.get("username");
        customConfirm(`Are you sure you want to create user '${username}'?`).then(confirmed => {
            if (confirmed) {
                document.getElementById("create-user-dialog").close();
                toggleLoading();
                fetch(`/api/user/${username}/create`, { method: "POST" }).then((response) => {
                    if (response.ok) {
                        location.href = `/user/${username}`;
                    } else {
                        response.text().then((text) => notifyError(text));
                        toggleLoading();
                    }
                });
            }
        });
    });

    function impersonateUser(username) {
        customConfirm(`Are you sure you want to impersonate user '${username}'?`).then(confirmed => {
            if (confirmed) {
                toggleLoading();
                fetch(`/api/user/${username}/impersonate`, { method: "POST" }).then((response) => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        response.text().then((text) => notifyError(text));
                        toggleLoading();
                    }
                });
            }
        });
    }
</script>
{{end}}