{{define "body"}}
<h1>Manage User - {{.TargetUsername}}</h1>

<details>
    <summary>Manage User</summary>
    <div style="display: grid; grid-auto-flow: column">
        <div style="text-align: center;">
            <button onclick="resetPassword()">Reset Password</button>
        </div>
        <div style="text-align: center;">
            <button onclick="deleteUser()">Delete User</button>
        </div>
    </div>
</details>

<h3>SSH Keys</h3>
<button onclick="document.getElementById('add-ssh-key-dialog').showModal()">
    Add New SSH Key
</button>
<br />
<br />
{{$sshKeyCount := len .SshKeys}}
{{if gt $sshKeyCount 0}}
<table>
    <thead>
        <tr>
            <th>SSH Key</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {{range $index, $sshKey := .SshKeys}}
        <tr>
            <td>{{$sshKey}}</td>
            <td>
                <button onclick="deleteSshKeyLine('{{$index}}')">
                    Delete SSH Key
                </button>
            </td>
        </tr>
        {{end}}
    </tbody>
</table>
{{end}}
<br />
<dialog id="add-ssh-key-dialog">
    <div style="display: grid; grid-auto-flow: column">
        <div>
            <h3>Add New SSH Key</h3>
        </div>
        <div>
            <span
                class="close-button"
                onclick="document.getElementById('add-ssh-key-dialog').close()"
            >&#128938;</span>
        </div>
    </div>
    <form id="add-ssh-key-form">
        <input
            type="text"
            name="username"
            value="{{.TargetUsername}}"
            required="required"
            hidden
        />
        <label for="addSshKey">SSH Key:</label>
        <input
            type="text"
            id="addSshKey"
            name="sshKey"
            maxlength="256"
            placeholder="Enter SSH Key"
            required="required"
            autocomplete="off"
        />
        <br />
        <br />
        <input
            type="submit"
            value="Add SSH Key"
        />
    </form>
</dialog>
<script>
    document.getElementById("add-ssh-key-form").addEventListener("submit", function (event) {
        event.preventDefault();
        const formData = new FormData(this);
        customConfirm("Are you sure you want to add this SSH Key?").then(confirmed => {
            if (confirmed) {
                document.getElementById("add-ssh-key-dialog").close();
                toggleLoading();
                fetch("/api/user/ssh-key", { method: "POST", body: formData }).then((response) => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        response.text().then((text) => notifyError(text));
                        toggleLoading();
                    }
                });
            }
        });
    });

    function deleteSshKeyLine(index) {
        customConfirm("Are you sure you want to delete this SSH Key?").then(confirmed => {
            if (confirmed) {
                toggleLoading();
                const formData = new FormData();
                formData.append("username", "{{.TargetUsername}}");
                formData.append("index", index);
                fetch("/api/user/ssh-key", { method: "DELETE", body: formData }).then((response) => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        response.text().then((text) => notifyError(text));
                        toggleLoading();
                    }
                });
            }
        });
    }

    function resetPassword() {
        customConfirm(`Are you sure you want to reset this user's password?`).then(confirmed => {
            if (confirmed) {
                toggleLoading();
                const formData = new FormData();
                formData.append("username", "{{.TargetUsername}}");
                fetch("/api/user/password/reset", { method: "POST", body: formData }).then((response) => {
                    if (response.ok) {
                        //{{if eq .Username .TargetUsername}}
                        logout();
                        //{{else}}
                        toggleLoading();
                        notifyInfo("Password reset successfully.");
                        //{{end}}
                    } else {
                        response.text().then((text) => notifyError(text));
                        toggleLoading();
                    }
                });
            }
        });
    }

    function deleteUser() {
        customConfirm(`Are you sure you want to delete this user?`).then(confirmed => {
            if (confirmed) {
                toggleLoading();
                const formData = new FormData();
                formData.append("username", "{{.TargetUsername}}");
                fetch("/api/user", { method: "DELETE", body: formData }).then((response) => {
                    if (response.ok) {
                        //{{if eq .Username .TargetUsername}}
                        logout();
                        //{{else}}
                        location.href = "/admin";
                        //{{end}}
                    } else {
                        response.text().then((text) => notifyError(text));
                        toggleLoading();
                    }
                });
            }
        });
    }
</script>
{{end}}